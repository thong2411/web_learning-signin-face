<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang ch·ªß</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 30px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    .user-details h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 5px;
    }
    .user-details p {
      color: #666;
      font-size: 14px;
      margin-bottom: 14px;
    }
    .btn {
      padding: 10px 25px;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      margin-right: 10px;
    }
    .logout-btn {
      background: #dc3545;
    }
    .logout-btn:hover {
      background: #c82333;
      transform: translateY(-2px);
    }
    .back-dash {
      background: #43d650;
    }
    .back-dash:hover {
      background: #32642a;
      transform: translateY(-2px);
    }
    .gesture-btn {
      background: #f5576c;
    }
    .gesture-btn:hover {
      background: #d64555;
      transform: translateY(-2px);
    }
    .gesture-btn.active {
      background: #28a745;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .welcome-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
    }
    .welcome-section h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .welcome-section p {
      font-size: 18px;
      opacity: 0.9;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }
    .content-section {
      margin-top: 30px;
    }
    .content-section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    .placeholder {
      background: #f8f9fa;
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 60px;
      text-align: left;
      color: #999;
      font-size: 50px;
    }
    
    /* Modal Realtime */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 900px;
      width: 90%;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      font-size: 24px;
      color: #333;
    }
    .close-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .video-container {
      position: relative;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    #webcam {
      width: 100%;
      height: auto;
      display: block;
    }
    .video-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
    }
    .gesture-big-display {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 10px;
      color: white;
      margin-bottom: 15px;
    }
    .gesture-big-display .label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    .gesture-big-display .gesture-text {
      font-size: 48px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .realtime-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-box .label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-box .value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .fps-counter {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: #28a745;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="user-info">
      <div class="avatar" id="avatar"></div>
      <div class="user-details">
        <h2 id="username">Loading...</h2>
        <p>ƒêƒÉng nh·∫≠p l√∫c: <span id="loginTime"></span></p>
        <button class="back-dash btn" onclick='backdash()'>Trang ch·ªß</button>
        <button class="gesture-btn btn" id="gestureBtn" onclick='toggleGestureMonitor()'>
          üéØ B·∫≠t theo d√µi c·ª≠ ch·ªâ
        </button>
      </div>
    </div>
    <button class="logout-btn btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </header>

  <div class="welcome-section">
    <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi kh√≥a h·ªçc Python</h1>
    <p>N∆°i ch√∫ng ta h·ªçc code c√πng nhau</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Th·ªùi gian online</h3>
      <div class="value" id="onlineTime">0 ph√∫t</div>
    </div>
    <div class="stat-card">
      <h3>Tr·∫°ng th√°i</h3>
      <div class="value" style="color: #28a745; font-size: 24px;">ƒê√£ x√°c th·ª±c</div>
    </div>
    <div class="stat-card">
      <h3>ƒê·ªô t∆∞∆°ng ƒë·ªìng</h3>
      <div class="value" id="similarity">---</div>
    </div>
  </div>

  <div class="content-section">
    <h2>N·ªôi dung c·ªßa b√†i h·ªçc Python</h2>
    <div class="placeholder">
      <p style="margin-top: 10px; font-size: 30px;"></p>
    </div>
  </div>
</div>

<!-- Modal Realtime Monitor -->
<div class="modal" id="gestureModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üé• Theo d√µi C·ª≠ ch·ªâ Realtime</h2>
      <button class="close-btn" onclick="stopGestureMonitor()">ƒê√≥ng</button>
    </div>
    
    <div class="video-container">
      <video id="webcam" autoplay></video>
      <div class="video-overlay" id="status">ƒêang kh·ªüi ƒë·ªông...</div>
      <div class="fps-counter">FPS: <span id="fps">0</span></div>
    </div>
    
    <div class="gesture-big-display">
      <div class="label">C·ª¨ CH·ªà HI·ªÜN T·∫†I</div>
      <div class="gesture-text" id="currentGesture">---</div>
    </div>
    
    <div class="realtime-stats">
      <div class="stat-box">
        <div class="label">G√≥c ngang (Yaw)</div>
        <div class="value" id="yaw">0¬∞</div>
      </div>
      <div class="stat-box">
        <div class="label">G√≥c d·ªçc (Pitch)</div>
        <div class="value" id="pitch">0¬∞</div>
      </div>
      <div class="stat-box">
        <div class="label">ƒê·ªô tin c·∫≠y</div>
        <div class="value" id="confidence">0%</div>
      </div>
    </div>
  </div>
</div>

<canvas id="canvas"></canvas>

<script>
  const API_URL = 'http://127.0.0.1:8000';
  let stream = null;
  let isMonitoring = false;
  let monitorInterval = null;
  let fpsCounter = 0;
  let lastFpsTime = Date.now();

  // Ki·ªÉm tra ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
  function checkAuth() {
    const username = localStorage.getItem('username');
    if (!username) {
      window.location.href = 'FE.html';
      return false;
    }
    return true;
  }

  // Load th√¥ng tin user
  function loadUserInfo() {
    const username = localStorage.getItem('username');
    const loginTime = localStorage.getItem('loginTime');
    const similarity = localStorage.getItem('similarity');

    document.getElementById('username').textContent = username;
    document.getElementById('avatar').textContent = username.charAt(0).toUpperCase();
    
    const time = new Date(loginTime);
    document.getElementById('loginTime').textContent = time.toLocaleString('vi-VN');
    
    if (similarity) {
      document.getElementById('similarity').textContent = (parseFloat(similarity) * 100).toFixed(1) + '%';
    }

    updateOnlineTime();
    setInterval(updateOnlineTime, 60000);
  }

  // C·∫≠p nh·∫≠t th·ªùi gian online
  function updateOnlineTime() {
    const loginTime = new Date(localStorage.getItem('loginTime'));
    const now = new Date();
    const minutes = Math.floor((now - loginTime) / 1000 / 60);
    
    if (minutes < 60) {
      document.getElementById('onlineTime').textContent = `${minutes} ph√∫t`;
    } else {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      document.getElementById('onlineTime').textContent = `${hours}h ${mins}m`;
    }
  }

  function backdash() {
    window.location.href = "FE.html";
  }

  function logout() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
      stopGestureMonitor();
      localStorage.removeItem('username');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('similarity');
      window.location.href = 'FE.html';
    }
  }

  // B·∫¨T/T·∫ÆT THEO D√ïI C·ª¨ CH·ªà
  async function toggleGestureMonitor() {
    if (isMonitoring) {
      stopGestureMonitor();
    } else {
      await startGestureMonitor();
    }
  }

  // B·∫ÆT ƒê·∫¶U THEO D√ïI
  async function startGestureMonitor() {
    try {
      // M·ªü modal
      document.getElementById('gestureModal').classList.add('active');
      
      // B·∫≠t webcam
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { width: 640, height: 480 } 
      });
      document.getElementById('webcam').srcObject = stream;
      
      // ƒê·ª£i video s·∫µn s√†ng
      await new Promise(resolve => {
        document.getElementById('webcam').onloadedmetadata = resolve;
      });
      
      document.getElementById('status').textContent = '‚úÖ ƒêang theo d√µi...';
      
      // B·∫≠t n√∫t
      const btn = document.getElementById('gestureBtn');
      btn.textContent = '‚èπ D·ª´ng theo d√µi';
      btn.classList.add('active');
      
      isMonitoring = true;
      
      // B·∫Øt ƒë·∫ßu g·ª≠i frame li√™n t·ª•c
      detectGestureContinuous();
      
    } catch (error) {
      alert('Kh√¥ng th·ªÉ b·∫≠t webcam: ' + error.message);
      stopGestureMonitor();
    }
  }

  // D·ª™NG THEO D√ïI
  function stopGestureMonitor() {
    isMonitoring = false;
    
    if (monitorInterval) {
      clearTimeout(monitorInterval);
      monitorInterval = null;
    }
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    
    document.getElementById('gestureModal').classList.remove('active');
    
    const btn = document.getElementById('gestureBtn');
    btn.textContent = 'üéØ B·∫≠t theo d√µi c·ª≠ ch·ªâ';
    btn.classList.remove('active');
  }

  // PH√ÅT HI·ªÜN LI√äN T·ª§C
  async function detectGestureContinuous() {
    if (!isMonitoring) return;
    
    try {
      // Ch·ª•p ·∫£nh t·ª´ webcam
      const imageData = captureImage();
      const blob = dataURLtoBlob(imageData);
      
      const formData = new FormData();
      formData.append('image', blob, 'capture.jpg');

      // G·ª≠i ƒë·∫øn API
      const response = await fetch(`${API_URL}/detect-head-gesture`, {
        method: 'POST',
        body: formData
      });

      const data = await response.json();
      
      // C·∫≠p nh·∫≠t UI
      updateGestureUI(data);
      
      // T√≠nh FPS
      fpsCounter++;
      const now = Date.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = fpsCounter;
        fpsCounter = 0;
        lastFpsTime = now;
      }
      
    } catch (error) {
      console.error('L·ªói:', error);
      document.getElementById('status').textContent = '‚ö†Ô∏è L·ªói k·∫øt n·ªëi';
    }
    
    // G·ªçi l·∫°i ngay l·∫≠p t·ª©c ƒë·ªÉ ƒë·∫°t FPS cao
    if (isMonitoring) {
      monitorInterval = setTimeout(detectGestureContinuous, 100); // ~10 FPS
    }
  }

  // C·∫¨P NH·∫¨T UI
  function updateGestureUI(data) {
    if (data.status === 'success' && data.data.detected) {
      const gesture = data.data.gesture;
      const yaw = data.data.yaw;
      const pitch = data.data.pitch;
      const confidence = data.data.confidence;
      
      document.getElementById('currentGesture').textContent = gesture;
      document.getElementById('yaw').textContent = yaw + '¬∞';
      document.getElementById('pitch').textContent = pitch + '¬∞';
      document.getElementById('confidence').textContent = (confidence * 100).toFixed(0) + '%';
      
      // ƒê·ªïi m√†u theo c·ª≠ ch·ªâ
      const display = document.querySelector('.gesture-big-display');
      if (gesture === 'Nh√¨n th·∫≥ng') {
        display.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
      } else if (gesture === 'Quay tr√°i' || gesture === 'Quay ph·∫£i') {
        display.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
      } else {
        display.style.background = 'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)';
      }
      
    } else {
      document.getElementById('currentGesture').textContent = data.data?.gesture || 'Kh√¥ng ph√°t hi·ªán';
      document.getElementById('yaw').textContent = '0¬∞';
      document.getElementById('pitch').textContent = '0¬∞';
      document.getElementById('confidence').textContent = '0%';
    }
  }

  // CH·ª§P ·∫¢NH T·ª™ WEBCAM
  function captureImage() {
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    return canvas.toDataURL('image/jpeg', 0.8); // Gi·∫£m ch·∫•t l∆∞·ª£ng ƒë·ªÉ tƒÉng t·ªëc
  }

  // CHUY·ªÇN BASE64 TH√ÄNH BLOB
  function dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
      u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
  }

  // Kh·ªüi ƒë·ªông
  if (checkAuth()) {
    loadUserInfo();
  }

  // ƒê√≥ng modal khi nh·∫•n ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isMonitoring) {
      stopGestureMonitor();
    }
  });
</script>

</body>
</html>